<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grocery Credit Ledger</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-3xl mx-auto bg-white shadow-lg rounded-xl p-6">
    <h1 class="text-2xl font-bold text-center mb-6">ðŸ›’ Grocery Credit Ledger</h1>

    <!-- Add New Customer -->
    <div class="mb-4">
      <input id="newCustomer" type="text" placeholder="Enter new customer name" class="border rounded w-2/3 p-2"/>
      <button onclick="addCustomer()" class="bg-green-500 text-white px-4 py-2 rounded">Add Customer</button>
    </div>

    <!-- Customer List -->
    <div class="mb-4">
      <label class="block font-medium mb-1">Customers:</label>
      <ul id="customerList" class="space-y-2"></ul>
    </div>

    <!-- Add Item -->
    <div class="mb-4">
      <label class="block font-medium mb-1">Add Item:</label>
      <input id="itemName" type="text" placeholder="Item name" class="border rounded w-full p-2 mb-2"/>
      <input id="unitPrice" type="number" placeholder="Unit Price" class="border rounded w-full p-2 mb-2"/>
      <input id="quantity" type="number" placeholder="Quantity" class="border rounded w-full p-2 mb-2"/>
      <button onclick="addItem()" class="bg-blue-500 text-white px-4 py-2 rounded">Add to Ledger</button>
    </div>

    <!-- Repayment -->
    <div class="mb-4">
      <label class="block font-medium mb-1">Repayment:</label>
      <input id="repayAmount" type="number" placeholder="Enter repayment amount" class="border rounded w-full p-2 mb-2"/>
      <button onclick="repayAmount()" class="bg-purple-500 text-white px-4 py-2 rounded">Add Repayment</button>
    </div>

    <!-- Ledger -->
    <h2 id="currentCustomer" class="text-xl font-bold mb-2">Customer</h2>
    <ul id="ledger" class="border rounded p-3 max-h-60 overflow-auto bg-gray-50"></ul>
    <p class="font-bold mt-2">Total: â‚¹<span id="totalAmount">0</span></p>

    <!-- PDF Download Button -->
    <button onclick="downloadPDF()" class="bg-red-500 text-white px-4 py-2 rounded mt-4">
      Download Statement (PDF)
    </button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDifqCInAwcB3MH1uQ5k8xo7AWYu6QB8YI",
      authDomain: "groceryledger-fc92b.firebaseapp.com",
      databaseURL: "https://groceryledger-fc92b-default-rtdb.firebaseio.com",
      projectId: "groceryledger-fc92b",
      storageBucket: "groceryledger-fc92b.appspot.com",
      messagingSenderId: "845558376752",
      appId: "1:845558376752:web:9c77018bde916c6d9640f5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentCustomerName = null;
    let currentListener = null;

    window.onload = updateCustomerList;

    function addCustomer() {
      const newName = document.getElementById("newCustomer").value.trim();
      if (!newName) return alert("Enter a name");

      const invalidChars = /[.#$[\]]/;
      if (invalidChars.test(newName)) {
        return alert("Customer name contains invalid characters.");
      }

      db.ref("ledgers/" + newName).once("value", snapshot => {
        if (!snapshot.exists()) {
          db.ref("ledgers/" + newName).set({ createdAt: Date.now() })
            .then(() => {
              document.getElementById("newCustomer").value = "";
              updateCustomerList();
            })
            .catch(error => {
              alert("Error adding customer: " + error.message);
            });
        } else {
          alert(newName + " already exists!");
        }
      });
    }

    function updateCustomerList() {
      const list = document.getElementById("customerList");
      db.ref("ledgers").on("value", snapshot => {
        list.innerHTML = "";
        snapshot.forEach(child => {
          const name = child.key;
          const li = document.createElement("li");
          li.className = "flex justify-between items-center bg-gray-100 p-2 rounded";

          const nameBtn = document.createElement("button");
          nameBtn.textContent = name;
          nameBtn.className = "text-blue-600 font-semibold";
          nameBtn.onclick = () => showLedger(name);

          const delBtn = document.createElement("button");
          delBtn.textContent = "ðŸ—‘ï¸";
          delBtn.className = "text-red-500 text-lg";
          delBtn.onclick = () => deleteCustomer(name);

          li.appendChild(nameBtn);
          li.appendChild(delBtn);
          list.appendChild(li);
        });
      });
    }

    function addItem() {
      if (!currentCustomerName) return alert("Select a customer first");
      const itemName = document.getElementById("itemName").value.trim();
      const unitPrice = parseFloat(document.getElementById("unitPrice").value);
      const quantity = parseInt(document.getElementById("quantity").value);
      if (itemName && !isNaN(unitPrice) && unitPrice > 0 && !isNaN(quantity) && quantity > 0) {
        const total = unitPrice * quantity;
        const entry = {
          type: "purchase",
          item: itemName,
          price: unitPrice,
          qty: quantity,
          total: total,
          timestamp: Date.now()
        };
        db.ref("ledgers/" + currentCustomerName).push(entry);
        document.getElementById("itemName").value = "";
        document.getElementById("unitPrice").value = "";
        document.getElementById("quantity").value = "";
      }
    }

    function repayAmount() {
      if (!currentCustomerName) return alert("Select a customer first");
      const repay = parseFloat(document.getElementById("repayAmount").value);
      if (!isNaN(repay) && repay > 0) {
        const entry = {
          type: "repayment",
          total: repay,
          timestamp: Date.now()
        };
        db.ref("ledgers/" + currentCustomerName).push(entry);
        document.getElementById("repayAmount").value = "";
      }
    }

    function showLedger(customer) {
      document.getElementById("currentCustomer").textContent = customer;
      const ledgerList = document.getElementById("ledger");
      ledgerList.innerHTML = "";
      let total = 0;

      if (currentListener) {
        db.ref("ledgers/" + currentCustomerName).off("value", currentListener);
      }

      currentCustomerName = customer;
      const ref = db.ref("ledgers/" + customer);

      const listener = snapshot => {
        ledgerList.innerHTML = "";
        total = 0;
        snapshot.forEach(child => {
          const entry = child.val();
          const li = document.createElement("li");
          if (entry.type === "purchase") {
            li.textContent = `${entry.qty} Ã— ${entry.item} @ â‚¹${entry.price} = â‚¹${entry.total}`;
            total += entry.total;
          } else if (entry.type === "repayment") {
            li.textContent = `Repayment: â‚¹${entry.total}`;
            total -= entry.total;
          }
          ledgerList.appendChild(li);
        });
        document.getElementById("totalAmount").textContent = total.toFixed(2);
      };

      ref.on("value", listener);
      currentListener = listener;
    }

    function deleteCustomer(name) {
      if (confirm(`Are you sure you want to delete ${name} and all their data?`)) {
        db.ref("ledgers/" + name).remove();
        document.getElementById("ledger").innerHTML = "";
        document.getElementById("currentCustomer").textContent = "Customer";
        document.getElementById("totalAmount").textContent = "0";
        currentCustomerName = null;
      }
    }

    async function downloadPDF() {
      if (!currentCustomerName) return alert("Select a customer first");

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const customer = currentCustomerName;
      const total = document.getElementById("totalAmount").textContent;

      doc.setFontSize(16);
      doc.text("ðŸ›’ Grocery Credit Ledger", 10, 10);
      doc.setFontSize(12);
      doc.text("Customer Name: " + customer, 10, 20);
      doc.text("Date: " + new Date().toLocaleString(), 10, 30);

      let y = 40;

      const snapshot = await db.ref("ledgers/" + customer).once("value");
      snapshot.forEach(child => {
        const entry = child.val();
        let line = "";

        if (entry.type === "purchase") {
          line = `${entry.qty} Ã— ${entry.item} @ â‚¹${entry.price} = â‚¹${entry.total}`;
        } else if (entry.type === "repayment") {
          line = `Repayment: â‚¹${entry.total}`;
        }

        // Add timestamp
        const dateStr = new Date(entry.timestamp).toLocaleString();
        doc.text(`${dateStr} - ${line}`, 10, y);
        y += 10;

        // Add new page if needed
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });

      doc.setFontSize(14);
      doc.text("Total Balance: â‚¹" + total, 10, y + 10);

      doc.save(customer + "_Statement.pdf");
    }

  </script>
</body>
</html>